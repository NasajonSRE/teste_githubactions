name: App Build

on:
  push:
    branches:
      - teste
  workflow_dispatch:
    
env:
  APP_NAME: ana-data
  ARGO_PROJECT: ana-data
  CHART_FOLDER: charts/projeto-ana
  HELM_REPO: git@github.com:NasajonSRE/helm.git
  BRANCH_NAME: development
  HARBOR_PROJECT: ana

jobs:

  init:

    runs-on: ubuntu-latest
    outputs:
      CLIENTES: ${{ env.nomes }}
      CLUSTER: ${{ env.cluster }}
      VERSION: ${{ env.version }}
      VAULT_URL: ${{ env.vault_url }}
      VALUES_FILE: ${{ env.values_file }}
      FILES: ${{ env.files }}
      NAMES: ${{ env.nomes }}

    steps:
    - uses: actions/checkout@v3
      with:
          ref: ${{github.base_ref}}

    - name: Set variables
      id: setvars
      run: |

        if [[ "${{github.base_ref}}" == "teste" || "${{github.ref}}" == "refs/heads/teste" ]]; then
          echo "cluster=nasajon-prod" >> "$GITHUB_ENV"
          echo "version=$BUILD" >> "$GITHUB_ENV"
          echo "vault_url=safe.nasajon.app" >> "$GITHUB_ENV"
          echo "values_file=-values.yaml" >> "$GITHUB_ENV"
          file_names=$(find ci -name "*-values.yaml" -type f -printf "%f\n" | grep -vE "qa-values.yaml|dev-values.yaml" | tr ' ' ',')
          echo $file_names
          echo "files=$file_names" >> "$GITHUB_ENV"
        fi

    - name: Obter Lista de Nomes de Arquivos
      id: get_files
      run: |
        names=()
        IFS=',' read -ra FILENAMES <<< "${{ env.files }}"
        for file in $IFS; do
          name="${file%-values.yaml}"
          names+=("$name")
        done
        echo "nomes=${names[@]}" >> "$GITHUB_ENV"

  build:

    runs-on: ubuntu-latest
    needs: init

    steps:
    - uses: actions/checkout@v3
      with:
          ref: ${{github.base_ref}}

    - name: Render Values in Helm git repo 
      env:
        NAMES: ${{ needs.init.outputs.NAMES }}
        CLUSTER: ${{ env.cluster }}
      run: | 
        echo Create temporary folder to clone the repo into...
        TEMP_FOLDER="$(mktemp -d)" 
        echo Clone the repository...
        git clone -b main "git@github.com:NasajonSRE/helm.git" ${TEMP_FOLDER}
        start=$pwd
        for client in $NAMES; do
          ls -lah
          cp ci/${client}-values.yaml ${TEMP_FOLDER}/${client}-values.yaml
          cd ${TEMP_FOLDER}/
          echo "Update Helm values with new image tag"
          sed -i "s/{{ TAG }}/$GITHUB_DOCKERTAG/g" ${client}-values.yaml
          cat ${client}-values.yaml
          cd $start/
        done
        echo "done"